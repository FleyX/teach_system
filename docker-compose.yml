version: "2"

services: 
  teachSystemMysql:
    image: mysql:5.7.25
    container_name: teachSystemMysql
    volumes: 
      - /etc/localtime:/etc/localtime
      - ./timezone:/ect/timezone
      - ./files/mysql/data:/var/lib/mysql
      - /files/mysql/my.cnf:/etc/mysql/my.cnf
    environment: 
      - MYSQL_ROOT_PASSWORD=$MYSQL_PASS
    ports: 
      - 3306:3306
    networks: teachSystem
  
  teachSystemRedis:
    image: redis:3.2.10
    container_name: teachSystemRedis
    networks: teachSystem
    volumes: 
      - /etc/localtime:/etc/localtime
      - ./timezone:/ect/timezone
      - ./files/redis/data:data
      - ./files/redis/redis.conf:/etc/redis/redis.conf
    ports: 
      - 6379:6379
    command: redis-server /etc/redis/redis.conf

  teachSystemFront:
    image: nginx
    container_name: teachSystemFront
    networks: teachSystem
    volumes: 
      - /etc/localtime:/etc/localtime
      - ./timezone:/ect/timezone
      - ./client/dist:/opt/dist
      - ./files/front/log:/var/log/nginx
      - ./files/front/nginx.conf:/etc/nginx/nginx.conf
    ports: 
      - 8085:8080

  teachSystemBackend:
    build: ./
    container_name: teachSystemBackend
    networks: teachSystem
    environment: 
      - mysqlHost="teachSystemMysql"
      - redisHost="teachSystemRedis"
      - mysqlPassword=$MYSQL_PASS
      - judgeToken=$JUDGE_TOKEN
      - judgeUrl="http://judgeServer:8080"
      - testSavePath="/opt/tests/test_case"
    volumes: 
      - /etc/localtime:/etc/localtime
      - ./timezone:/ect/timezone
      - ./teachSystem:/opt/workspace
      - ../JudgeServer/tests/:/opt/tests
    ports: 
      - 8089:8088

  # 启动判题核心
  judgeServer:
    image: registry.cn-hangzhou.aliyuncs.com/onlinejudge/judge_server
    read_only: true
    networks: teachSystem
    cap_drop:
        - SETPCAP
        - MKNOD
        - NET_BIND_SERVICE
        - SYS_CHROOT
        - SETFCAP
        - FSETID
    tmpfs:
        - /tmp
    volumes:
        - ../JudgeServer/tests/test_case:/test_case:ro
        - ../JudgeServer/log:/log
        - ../JudgeServer/run:/judger
    environment:
        - BACKEND_URL=http://backend:80/api/judge_server_heartbeat
        - SERVICE_URL=http://judge-server:12358
        - TOKEN=$JUDGE_TOKEN
    ports:
        - "0.0.0.0:12358:8080"






